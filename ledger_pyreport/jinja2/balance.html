{#
    ledger-pyreport
    Copyright Â© 2020  Lee Yingtong Li (RunasSudo)
 
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.
 
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.
 
    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
#}

{% macro print_rows(account, invert=False, level=0) %}
	<tr>
		<td style="padding-left: calc(2px + {{ level }}em);">
			{% if balance_sheets|length == 1 %}
				{% if account.name == config['current_year_earnings'] %}
					<a href="/pandl?{{ {'date_end': balance_sheets[0].date.strftime('%Y-%m-%d'), 'date_beg': balance_sheets[0].pstart.strftime('%Y-%m-%d'), 'compare': '0'}|urlencode }}">
				{% else %}
					<a href="/transactions?{{ {'date': balance_sheets[0].date.strftime('%Y-%m-%d'), 'pstart': balance_sheets[0].pstart.strftime('%Y-%m-%d'), 'account': account.name}|urlencode }}">
				{% endif %}
					{{ account.bits[-1] }}
				</a>
			{% else %}
				{{ account.bits[-1] }}
			{% endif %}
		</td>
		{% for balance_sheet in balance_sheets %}
			{% set amount = (-balance_sheet.get_balance(account) if invert else balance_sheet.get_balance(account)).exchange(report_currency, True) %}
			<td>
				{% if amount != 0 %}
					{% if account.name == config['current_year_earnings'] %}
						<a href="/pandl?{{ {'date_end': balance_sheet.date.strftime('%Y-%m-%d'), 'date_beg': balance_sheets[0].pstart.strftime('%Y-%m-%d'), 'compare': '0'}|urlencode }}">
					{% else %}
						<a href="/transactions?{{ {'date': balance_sheet.date.strftime('%Y-%m-%d'), 'pstart': balance_sheet.pstart.strftime('%Y-%m-%d'), 'account': account.name}|urlencode }}">
					{% endif %}
						{{ amount|a }}
					</a>
				{% endif %}
			</td>
		{% endfor %}
	</tr>
	
	{% for child in account.children if child in accounts %}
		{{ print_rows(child, invert, level + 1) }}
	{% endfor %}
{% endmacro %}

{% macro do_accounts(root, label, invert, year_headers) %}
	{% for account_class in root.children if account_class in accounts %}
		<tr>
			{% if loop.first and year_headers %}
				<th class="h2">{{ account_class.bits[-1] }} {{ label }}</th>
				{% for balance_sheet in balance_sheets %}<th class="h2">{{ balance_sheet.date.strftime('%Y') }}&nbsp;</th>{% endfor %}
			{% else %}
				<th class="h2" colspan="{{ balance_sheets|length + 1 }}">{{ account_class.bits[-1] }} {{ label }}</th>
			{% endif %}
		</tr>
		
		{% for account in account_class.children if account in accounts %}
			{{ print_rows(account, invert=invert) }}
		{% endfor %}
		
		<tr class="total">
			<td>Total {{ account_class.bits[-1] }} {{ label }}</td>
			{% for balance_sheet in balance_sheets %}<td>{{ (-balance_sheet.get_total(account_class) if invert else balance_sheet.get_total(account_class)).exchange(report_currency, True)|a }}</td>{% endfor %}
		</tr>
		<tr><td colspan="2">&nbsp;</td></tr>
	{% endfor %}
	
	<tr class="total">
		<td>Total {{ label }}</td>
		{% for balance_sheet in balance_sheets %}<td>{{ (-balance_sheet.get_total(root) if invert else balance_sheet.get_total(root)).exchange(report_currency, True)|a }}</td>{% endfor %}
	</tr>
{% endmacro %}

<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Balance Sheet as at {{ balance_sheets[0].date.strftime('%d %B %Y') }}</title>
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous">
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='main.css') }}">
	</head>
	<body>
		<h1>Balance Sheet</h1>
		<h2>As at {{ balance_sheets[0].date.strftime('%d %B %Y') }}</h2>
		
		<table class="ledger onedesc">
			{# Assets #}
			<tr><th class="h1" colspan="{{ balance_sheets|length + 1 }}">Assets</th></tr>
			{{ do_accounts(ledger.get_account(config['assets_account']), 'Assets', False, True) }}
			<tr><td colspan="2">&nbsp;</td></tr>
			
			{# Liabilities #}
			<tr><th class="h1" colspan="{{ balance_sheets|length + 1 }}">Liabilities</th></tr>
			{{ do_accounts(ledger.get_account(config['liabilities_account']), 'Liabilities', True, False) }}
			<tr><td colspan="2">&nbsp;</td></tr>
			
			{# Equity #}
			<tr><th class="h1" colspan="{{ balance_sheets|length + 1 }}">Equity</th></tr>
			
			{% for account in ledger.get_account(config['equity_account']).children if account in accounts %}
				{{ print_rows(account, invert=True) }}
			{% endfor %}
			
			<tr class="total">
				<td>Total Equity</td>
				{% for balance_sheet in balance_sheets %}<td>{{ -balance_sheet.get_total(ledger.get_account(config['equity_account'])).exchange(report_currency, True)|a }}</td>{% endfor %}
			</tr>
		</table>
	</body>
</html>
